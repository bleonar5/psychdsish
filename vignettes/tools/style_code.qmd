---
title: "Apply {tidyverse} code style"
format:
  html:
    toc: true
    code-fold: true
execute:
  warning: false
  message: false
---

# Generate poorly styled code

Copy and paste the output into a new chunk to then style it.

```{r}

# devtools::install_github("ianhussey/psychdsish")
library(psychdsish)

psychdsish::print_poorly_styled_code()

```

# Restyle using {tidyverse} style guide

Note that this code is valid and runs, it's just hideous to try to read.

See [here](https://styler.r-lib.org/) for .gif of how {styler} works with point and click.

Highlight the code and restyle using 'Addins>STYLER>Style selection'

```{r}

library(dplyr)
library(ggplot2)
library(stringr)

mtcars %>% mutate(am=ifelse(am==1,
"manual","automatic"),gear=factor(
  gear
))%>%
group_by(
  cyl,am)%>%
summarise(avg_mpg=mean(mpg,na.rm=TRUE),
                       med_hp=median(hp),
                       count=n(),
                       .groups="drop"
                       )%>%
filter(avg_mpg>18|med_hp>100)%>%
mutate(flag=ifelse(avg_mpg>20&med_hp>110,TRUE,
                   FALSE),hp_per_cyl=med_hp/cyl)%>%arrange(desc(avg_mpg))%>%
left_join(
  mtcars%>%count(cyl, gear),by="cyl"  )%>%
mutate(label=str_c("cyl: ",cyl,"; am: ",am))%>%
ggplot(aes(x=reorder(
  label,
  avg_mpg
),y=avg_mpg,fill=
am))+geom_col(width  =   0.7,
              color  =   "black")+geom_text( aes( label = round(avg_mpg,1)),vjust = -0.5,size = 3)+
facet_wrap(~gear,scales="free_x")+theme_minimal(
)+theme(
axis.text.x=element_text(angle=45,hjust=1)
)+labs(
x="Group",y="Average MPG",title="Badly Styled Tidyverse Example")+
guides(fill=guide_legend(title="Transmission"))+coord_flip()

```

# Style a specific file

{styler} can also be called as a function on a given file. Less likely to be used by students. 

```{r}
#| eval: false # example.qmd doesn't exist, so dont run chunk

library(styler)
styler::style_file("example.qmd")

```

# Recursively find all .R/.Rmd/.qmd files in a project and restyle all of them 

I wrote a wrapper function to apply `style_file()` to every .R, .Rmd and .qmd file in a directory or its subdirectories. More likely to be used by students when a script doing this can be auto-generated within {psychdsish}'s skeleton project structure and tools. 

```{r}

# assess which files would be touched
# search the parent folder one directory above that which contains this file, assuming the files in in 'project/tools'
psychdsish::style_all_files(root = "../", dry_run = TRUE) 

# restyle those files
psychdsish::style_all_files(root = "../")

```

